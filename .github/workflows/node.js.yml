# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Node.js CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:

    runs-on: ubuntu-latest
# Levantamos el servidor de la base de datos de Posgresql
    services:
      db:
        image: postgres:15
        env:
            POSTGRES_USER: "user_test"
            POSTGRES_PASSWORD: "password_test"
            POSTGRES_DB: "db_test"
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U user_test -d db_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DB_USER: user_test
      DB_PASSWORD: password_test
      DB_NAME: db_test
      DB_HOST: localhost
      DB_PORT: 5432
      DB_CONNECTION_STRING: postgresql://user_test:password_test@localhost:5432/db_test
    

    strategy:
      matrix:
        node-version: [22.x]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/



    steps:
      - name: Mostrar variables de entorno
        run: |
          echo "DB_USER: $DB_USER"
          echo "DB_HOST: $DB_HOST"
          echo "DB_CONNECTION_STRING: $DB_CONNECTION_STRING"
    

      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Instalar dependencias
        run: npm ci
      - name: Hacer el build
        run: npm run build --if-present
      - name: Esperar a Postgres
        run: |
          for i in {1..10}; do
            pg_isready -h localhost -p 5432 -U user_test && break
            sleep 2
          done
      - name: Crear extensi√≥n pgcrypto
        run: |
          PGPASSWORD=password_test psql -h localhost -U user_test -d db_test -c 'CREATE EXTENSION IF NOT EXISTS "pgcrypto";'
      - name: Inicializar Base de Datos
        run: |
          PGPASSWORD=password_test psql -h localhost -U user_test -d db_test -f ./database/init.sql
      - name: Ejecutar tests
        run: npm test
